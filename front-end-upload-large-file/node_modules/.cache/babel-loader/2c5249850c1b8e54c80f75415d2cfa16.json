{"ast":null,"code":"var _jsxFileName = \"/home/chuducanh/learn/large-file-upload/front-end-upload-large-file/src/upload.js\",\n    _s = $RefreshSig$();\n\nimport { Button, Progress } from \"antd\";\nimport React, { useEffect, useState } from \"react\";\nimport axios from \"axios\";\nimport { Upload } from \"antd\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst chunkSize = 1048576 * 100;\nexport const UploadComponent = () => {\n  _s();\n\n  const [showProgress, setShowProgress] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [fileState, setFileState] = useState({\n    fileSize: 0,\n    fileId: \"\",\n    totalChunks: 0,\n    totalChunksUploaded: 0,\n    startChunk: 0,\n    endChunk: chunkSize,\n    fileToUpload: null,\n    uploadedBytes: 0\n  });\n\n  const resetState = () => {\n    setFileState({\n      fileSize: 0,\n      fileId: \"\",\n      totalChunks: 0,\n      totalChunksUploaded: 0,\n      startChunk: 0,\n      endChunk: chunkSize,\n      fileToUpload: null,\n      uploadedBytes: 0\n    });\n  };\n\n  const uploadChunk = chunk => {\n    console.table({ ...fileState,\n      fileToUpload: \"\"\n    });\n    const {\n      fileId,\n      startChunk,\n      endChunk,\n      fileSize,\n      totalChunksUploaded,\n      uploadedBytes\n    } = fileState;\n    axios.post(\"http://localhost:3002/upload/files\", chunk, {\n      headers: {\n        \"x-file-name\": fileId,\n        \"Content-Range\": `bytes ${startChunk}-${endChunk}/${fileSize}`,\n        \"file-size\": fileSize\n      }\n    }).then(_ref => {\n      let {\n        data\n      } = _ref;\n      const endingChunk = Math.min(endChunk + chunkSize, fileSize);\n      setFileState({ ...fileState,\n        totalChunksUploaded: totalChunksUploaded + 1,\n        startChunk: endChunk,\n        endChunk: endingChunk === fileSize ? endingChunk + 1 : endingChunk,\n        uploadedBytes: endingChunk\n      });\n      const prog = fileSize ? uploadedBytes / fileSize * 100 : 0.1;\n      setProgress(prog);\n    });\n  };\n\n  const fileUpload = totalChunksUploaded => {\n    const {\n      totalChunks,\n      fileToUpload,\n      startChunk,\n      endChunk,\n      fileId\n    } = fileState;\n\n    if (totalChunksUploaded <= totalChunks) {\n      var chunk = fileToUpload.slice(startChunk, endChunk);\n      uploadChunk(chunk);\n    } else {\n      axios.post(\"http://localhost:3002/upload/complete\", {\n        headers: {\n          \"x-file-name\": fileId\n        }\n      }).then(resetState);\n    }\n  };\n\n  useEffect(() => {\n    if (fileState.fileSize > 0) {\n      fileUpload(fileState.totalChunksUploaded);\n    }\n  }, [fileState.fileSize, fileState.totalChunksUploaded]);\n\n  const getFileContext = e => {\n    console.log(e);\n    setShowProgress(true);\n    setProgress(0);\n    resetState();\n    const file_obj = e.fileList[0];\n    const fileId = `${file_obj.size}-${file_obj.lastModified}-${file_obj.name}`;\n    axios.get(\"http://localhost:3002/upload/status\", {\n      headers: {\n        \"x-file-name\": fileId,\n        \"file-size\": file_obj.size\n      }\n    }).then(_ref2 => {\n      let {\n        data\n      } = _ref2;\n      const uploadedBytes = data.uploaded;\n      console.log(\"uploaded bytes \", uploadedBytes);\n      const bytesRemaining = file_obj.size - uploadedBytes;\n      const endingChunk = Math.min(uploadedBytes + chunkSize, file_obj.size);\n      setFileState({\n        fileSize: file_obj.size,\n        fileId,\n        totalChunks: Math.ceil(bytesRemaining / chunkSize),\n        totalChunksUploaded: 0,\n        startChunk: uploadedBytes,\n        endChunk: endingChunk === fileState.fileSize ? endingChunk + 1 : endingChunk,\n        fileToUpload: file_obj,\n        uploadedBytes\n      });\n    }).catch(err => console.error(\"Status call failed \", err));\n  };\n\n  const progressInstance = /*#__PURE__*/_jsxDEV(Progress, {\n    percent: progress\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 139,\n    columnNumber: 9\n  }, this);\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(Upload, {\n        onChange: getFileContext,\n        children: \"btn\"\n      }, \"123123\", false, {\n        fileName: _jsxFileName,\n        lineNumber: 145,\n        columnNumber: 13\n      }, this), showProgress && progressInstance]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 144,\n      columnNumber: 9\n    }, this)\n  }, void 0, false);\n};\n\n_s(UploadComponent, \"JQuxDdggcLpJGQILcutOyfqEUkw=\");\n\n_c = UploadComponent;\n\nvar _c;\n\n$RefreshReg$(_c, \"UploadComponent\");","map":{"version":3,"sources":["/home/chuducanh/learn/large-file-upload/front-end-upload-large-file/src/upload.js"],"names":["Button","Progress","React","useEffect","useState","axios","Upload","chunkSize","UploadComponent","showProgress","setShowProgress","progress","setProgress","fileState","setFileState","fileSize","fileId","totalChunks","totalChunksUploaded","startChunk","endChunk","fileToUpload","uploadedBytes","resetState","uploadChunk","chunk","console","table","post","headers","then","data","endingChunk","Math","min","prog","fileUpload","slice","getFileContext","e","log","file_obj","fileList","size","lastModified","name","get","uploaded","bytesRemaining","ceil","catch","err","error","progressInstance"],"mappings":"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","sourcesContent":["\n\nimport { Button, Progress } from \"antd\";\nimport React, { useEffect, useState } from \"react\";\nimport axios from \"axios\";\nimport { Upload } from \"antd\";\n\nconst chunkSize = 1048576 * 100;\n\nexport const UploadComponent = () => {\n\n    const [showProgress, setShowProgress] = useState(false);\n    const [progress, setProgress] = useState(0);\n    const [fileState, setFileState] = useState({\n        fileSize: 0,\n        fileId: \"\",\n        totalChunks: 0,\n        totalChunksUploaded: 0,\n        startChunk: 0,\n        endChunk: chunkSize,\n        fileToUpload: null,\n        uploadedBytes: 0,\n    });\n\n\n\n    const resetState = () => {\n        setFileState({\n            fileSize: 0,\n            fileId: \"\",\n            totalChunks: 0,\n            totalChunksUploaded: 0,\n            startChunk: 0,\n            endChunk: chunkSize,\n            fileToUpload: null,\n            uploadedBytes: 0,\n        });\n    };\n\n    const uploadChunk = (chunk) => {\n        console.table({ ...fileState, fileToUpload: \"\" });\n        const {\n            fileId,\n            startChunk,\n            endChunk,\n            fileSize,\n            totalChunksUploaded,\n            uploadedBytes,\n        } = fileState;\n        axios\n            .post(\"http://localhost:3002/upload/files\", chunk, {\n                headers: {\n                    \"x-file-name\": fileId,\n                    \"Content-Range\": `bytes ${startChunk}-${endChunk}/${fileSize}`,\n                    \"file-size\": fileSize,\n                },\n            })\n            .then(({ data }) => {\n                const endingChunk = Math.min(endChunk + chunkSize, fileSize);\n\n                setFileState({\n                    ...fileState,\n                    totalChunksUploaded: totalChunksUploaded + 1,\n                    startChunk: endChunk,\n                    endChunk: endingChunk === fileSize ? endingChunk + 1 : endingChunk,\n                    uploadedBytes: endingChunk,\n                });\n                const prog = fileSize ? (uploadedBytes / fileSize) * 100 : 0.1;\n                setProgress(prog);\n            });\n    };\n\n    const fileUpload = (totalChunksUploaded) => {\n        const {\n            totalChunks,\n            fileToUpload,\n            startChunk,\n            endChunk,\n            fileId,\n        } = fileState;\n        if (totalChunksUploaded <= totalChunks) {\n            var chunk = fileToUpload.slice(startChunk, endChunk);\n            uploadChunk(chunk);\n        } else {\n            axios\n                .post(\"http://localhost:3002/upload/complete\", {\n                    headers: {\n                        \"x-file-name\": fileId,\n                    },\n                })\n                .then(resetState);\n        }\n    };\n\n    useEffect(() => {\n        if (fileState.fileSize > 0) {\n            fileUpload(fileState.totalChunksUploaded);\n        }\n    }, [fileState.fileSize, fileState.totalChunksUploaded]);\n\n\n\n    const getFileContext = (e) => {\n        console.log(e);\n        setShowProgress(true);\n        setProgress(0);\n        resetState();\n        const file_obj = e.fileList[0];\n        const fileId = `${file_obj.size}-${file_obj.lastModified}-${file_obj.name}`;\n\n        axios\n            .get(\"http://localhost:3002/upload/status\", {\n                headers: {\n                    \"x-file-name\": fileId,\n                    \"file-size\": file_obj.size,\n                },\n            })\n            .then(({ data }) => {\n                const uploadedBytes = data.uploaded;\n                console.log(\"uploaded bytes \", uploadedBytes);\n                const bytesRemaining = file_obj.size - uploadedBytes;\n                const endingChunk = Math.min(uploadedBytes + chunkSize, file_obj.size);\n                setFileState({\n                    fileSize: file_obj.size,\n                    fileId,\n                    totalChunks: Math.ceil(bytesRemaining / chunkSize),\n                    totalChunksUploaded: 0,\n                    startChunk: uploadedBytes,\n                    endChunk:\n                        endingChunk === fileState.fileSize ? endingChunk + 1 : endingChunk,\n                    fileToUpload: file_obj,\n                    uploadedBytes,\n                });\n            })\n            .catch((err) => console.error(\"Status call failed \", err));\n    };\n\n    const progressInstance = (\n        <Progress percent={progress} />\n    );\n\n\n    return (<>\n        <div>\n            <Upload onChange={getFileContext} key=\"123123\">\n                btn\n            </Upload>\n            {showProgress && progressInstance}\n        </div>\n    </>)\n}"]},"metadata":{},"sourceType":"module"}