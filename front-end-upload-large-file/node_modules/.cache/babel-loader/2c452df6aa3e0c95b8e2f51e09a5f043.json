{"ast":null,"code":"var _jsxFileName = \"/home/chuducanh/learn/large-file-upload/front-end-upload-large-file/src/upload.js\",\n    _s = $RefreshSig$();\n\nimport { Button, Progress, Upload } from \"antd\";\nimport axios from \"axios\";\nimport React, { useEffect, useState } from \"react\";\nimport { UploadOutlined } from '@ant-design/icons';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nimport { Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst chunkSize = 10000;\nexport const UploadComponent = () => {\n  _s();\n\n  const [showProgress, setShowProgress] = useState(false);\n  const [progress, setProgress] = useState(0);\n  const [fileState, setFileState] = useState({\n    fileSize: 0,\n    fileId: \"\",\n    totalChunks: 0,\n    totalChunksUploaded: 0,\n    startChunk: 0,\n    endChunk: chunkSize,\n    fileToUpload: null,\n    uploadedBytes: 0\n  });\n  const [preUploadFileState, setPreUploadFileState] = useState({\n    fileSize: 0,\n    fileId: \"\",\n    totalChunks: 0,\n    totalChunksUploaded: 0,\n    startChunk: 0,\n    endChunk: chunkSize,\n    fileToUpload: null,\n    uploadedBytes: 0\n  });\n\n  const resetState = () => {\n    setFileState({\n      fileSize: 0,\n      fileId: \"\",\n      totalChunks: 0,\n      totalChunksUploaded: 0,\n      startChunk: 0,\n      endChunk: chunkSize,\n      fileToUpload: null,\n      uploadedBytes: 0\n    });\n  };\n\n  const uploadChunk = chunk => {\n    console.table({ ...fileState,\n      fileToUpload: \"\"\n    });\n    const {\n      fileId,\n      startChunk,\n      endChunk,\n      fileSize,\n      totalChunksUploaded,\n      uploadedBytes\n    } = fileState;\n    axios.post(\"http://localhost:3002/upload/files\", chunk, {\n      headers: {\n        \"x-file-name\": fileId,\n        \"Content-Range\": `bytes ${startChunk}-${endChunk}/${fileSize}`,\n        \"file-size\": fileSize\n      }\n    }).then(_ref => {\n      let {\n        data\n      } = _ref;\n      const endingChunk = Math.min(endChunk + chunkSize, fileSize);\n      setFileState({ ...fileState,\n        totalChunksUploaded: totalChunksUploaded + 1,\n        startChunk: endChunk,\n        endChunk: endingChunk === fileSize ? endingChunk + 1 : endingChunk,\n        uploadedBytes: endingChunk\n      });\n      const prog = fileSize ? uploadedBytes / fileSize * 100 : 0.1;\n      setProgress(prog);\n    });\n  };\n\n  const fileUpload = totalChunksUploaded => {\n    const {\n      totalChunks,\n      fileToUpload,\n      startChunk,\n      endChunk,\n      fileId\n    } = fileState;\n\n    if (totalChunksUploaded <= totalChunks) {\n      var chunk = fileToUpload.slice(startChunk, endChunk);\n      uploadChunk(chunk);\n    } else {\n      axios.post(\"http://localhost:3002/upload/complete\", {\n        headers: {\n          \"x-file-name\": fileId\n        }\n      }).then(resetState);\n    }\n  };\n\n  useEffect(() => {\n    if (fileState.fileSize > 0) {\n      fileUpload(fileState.totalChunksUploaded);\n    }\n  }, [fileState.fileSize, fileState.totalChunksUploaded]);\n\n  const getFileContext = e => {\n    console.log(\"change value 1111\");\n    setShowProgress(true);\n    setProgress(0);\n    resetState();\n    const file_obj = e.fileList[0].originFileObj;\n    const fileId = `${file_obj.size}-${file_obj.lastModified}-${file_obj.name}`;\n    axios.get(\"http://localhost:3002/upload/status\", {\n      headers: {\n        \"x-file-name\": fileId,\n        \"file-size\": file_obj.size\n      }\n    }).then(_ref2 => {\n      let {\n        data\n      } = _ref2;\n      const uploadedBytes = data.uploaded;\n      const bytesRemaining = file_obj.size - uploadedBytes;\n      console.log(\"uploaded bytes \", uploadedBytes);\n      console.log(\"Byte remaining\", bytesRemaining);\n      const endingChunk = Math.min(uploadedBytes + chunkSize, file_obj.size);\n      setFileState({\n        fileSize: file_obj.size,\n        fileId,\n        totalChunks: Math.ceil(bytesRemaining / chunkSize),\n        totalChunksUploaded: 0,\n        startChunk: uploadedBytes,\n        endChunk: endingChunk === fileState.fileSize ? endingChunk + 1 : endingChunk,\n        fileToUpload: file_obj,\n        uploadedBytes\n      });\n    }).catch(err => console.error(\"Status call failed \", err));\n  };\n\n  return /*#__PURE__*/_jsxDEV(_Fragment, {\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      children: [/*#__PURE__*/_jsxDEV(Upload, {\n        onChange: getFileContext,\n        children: /*#__PURE__*/_jsxDEV(Button, {\n          icon: /*#__PURE__*/_jsxDEV(UploadOutlined, {}, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 157,\n            columnNumber: 31\n          }, this),\n          children: \"Upload\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 157,\n          columnNumber: 17\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 156,\n        columnNumber: 13\n      }, this), showProgress && /*#__PURE__*/_jsxDEV(Progress, {\n        percent: progress\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 159,\n        columnNumber: 30\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 155,\n      columnNumber: 9\n    }, this)\n  }, void 0, false);\n};\n\n_s(UploadComponent, \"SdGGZXxyJZFTUqWb5dxYrXgRH1I=\");\n\n_c = UploadComponent;\n\nvar _c;\n\n$RefreshReg$(_c, \"UploadComponent\");","map":{"version":3,"sources":["/home/chuducanh/learn/large-file-upload/front-end-upload-large-file/src/upload.js"],"names":["Button","Progress","Upload","axios","React","useEffect","useState","UploadOutlined","chunkSize","UploadComponent","showProgress","setShowProgress","progress","setProgress","fileState","setFileState","fileSize","fileId","totalChunks","totalChunksUploaded","startChunk","endChunk","fileToUpload","uploadedBytes","preUploadFileState","setPreUploadFileState","resetState","uploadChunk","chunk","console","table","post","headers","then","data","endingChunk","Math","min","prog","fileUpload","slice","getFileContext","e","log","file_obj","fileList","originFileObj","size","lastModified","name","get","uploaded","bytesRemaining","ceil","catch","err","error"],"mappings":"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","sourcesContent":["\n\nimport { Button, Progress, Upload } from \"antd\";\nimport axios from \"axios\";\nimport React, { useEffect, useState } from \"react\";\nimport { UploadOutlined } from '@ant-design/icons';\n\nconst chunkSize = 10000;\n\nexport const UploadComponent = () => {\n\n    const [showProgress, setShowProgress] = useState(false);\n    const [progress, setProgress] = useState(0);\n    const [fileState, setFileState] = useState({\n        fileSize: 0,\n        fileId: \"\",\n        totalChunks: 0,\n        totalChunksUploaded: 0,\n        startChunk: 0,\n        endChunk: chunkSize,\n        fileToUpload: null,\n        uploadedBytes: 0,\n    });\n\n    const [preUploadFileState, setPreUploadFileState] = useState({\n        fileSize: 0,\n        fileId: \"\",\n        totalChunks: 0,\n        totalChunksUploaded: 0,\n        startChunk: 0,\n        endChunk: chunkSize,\n        fileToUpload: null,\n        uploadedBytes: 0,\n    })\n\n\n\n    const resetState = () => {\n        setFileState({\n            fileSize: 0,\n            fileId: \"\",\n            totalChunks: 0,\n            totalChunksUploaded: 0,\n            startChunk: 0,\n            endChunk: chunkSize,\n            fileToUpload: null,\n            uploadedBytes: 0,\n        });\n    };\n\n    const uploadChunk = (chunk) => {\n        console.table({ ...fileState, fileToUpload: \"\" });\n        const {\n            fileId,\n            startChunk,\n            endChunk,\n            fileSize,\n            totalChunksUploaded,\n            uploadedBytes,\n        } = fileState;\n        axios\n            .post(\"http://localhost:3002/upload/files\", chunk, {\n                headers: {\n                    \"x-file-name\": fileId,\n                    \"Content-Range\": `bytes ${startChunk}-${endChunk}/${fileSize}`,\n                    \"file-size\": fileSize,\n                },\n            })\n            .then(({ data }) => {\n                const endingChunk = Math.min(endChunk + chunkSize, fileSize);\n\n                setFileState({\n                    ...fileState,\n                    totalChunksUploaded: totalChunksUploaded + 1,\n                    startChunk: endChunk,\n                    endChunk: endingChunk === fileSize ? endingChunk + 1 : endingChunk,\n                    uploadedBytes: endingChunk,\n                });\n                const prog = fileSize ? (uploadedBytes / fileSize) * 100 : 0.1;\n                setProgress(prog);\n            });\n    };\n\n    const fileUpload = (totalChunksUploaded) => {\n        const {\n            totalChunks,\n            fileToUpload,\n            startChunk,\n            endChunk,\n            fileId,\n        } = fileState;\n        if (totalChunksUploaded <= totalChunks) {\n            var chunk = fileToUpload.slice(startChunk, endChunk);\n            uploadChunk(chunk);\n        } else {\n            axios\n                .post(\"http://localhost:3002/upload/complete\", {\n                    headers: {\n                        \"x-file-name\": fileId,\n                    },\n                })\n                .then(resetState);\n        }\n    };\n\n    useEffect(() => {\n        if (fileState.fileSize > 0) {\n            fileUpload(fileState.totalChunksUploaded);\n        }\n    }, [fileState.fileSize, fileState.totalChunksUploaded]);\n\n\n\n    const getFileContext = (e) => {\n\n        console.log(\"change value 1111\")\n\n        setShowProgress(true);\n        setProgress(0);\n        resetState();\n\n        const file_obj = e.fileList[0].originFileObj;\n        const fileId = `${file_obj.size}-${file_obj.lastModified}-${file_obj.name}`;\n\n        axios\n            .get(\"http://localhost:3002/upload/status\", {\n                headers: {\n                    \"x-file-name\": fileId,\n                    \"file-size\": file_obj.size,\n                },\n            })\n            .then(({ data }) => {\n                const uploadedBytes = data.uploaded;\n                const bytesRemaining = file_obj.size - uploadedBytes;\n                console.log(\"uploaded bytes \", uploadedBytes);\n                console.log(\"Byte remaining\", bytesRemaining);\n                const endingChunk = Math.min(uploadedBytes + chunkSize, file_obj.size);\n                setFileState({\n                    fileSize: file_obj.size,\n                    fileId,\n                    totalChunks: Math.ceil(bytesRemaining / chunkSize),\n                    totalChunksUploaded: 0,\n                    startChunk: uploadedBytes,\n                    endChunk:\n                        endingChunk === fileState.fileSize ? endingChunk + 1 : endingChunk,\n                    fileToUpload: file_obj,\n                    uploadedBytes,\n                });\n            })\n            .catch((err) => console.error(\"Status call failed \", err));\n    };\n\n\n    return (<>\n        <div>\n            <Upload onChange={getFileContext} >\n                <Button icon={<UploadOutlined />}>Upload</Button>\n            </Upload>\n            {showProgress && <Progress percent={progress} />}\n        </div>\n    </>)\n}"]},"metadata":{},"sourceType":"module"}